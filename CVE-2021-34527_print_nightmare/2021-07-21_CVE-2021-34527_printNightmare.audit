<check_type:"Windows" version:"2">
    <group_policy:"Windows">
        <if>
            <condition type: "AND">
                <custom_item>
                    type         : REGISTRY_SETTING
                    description  : "CVE-2021-34527 - Point and Print registry check for PointAndPrint Registry setting for NoWarningNoElevationOnInstall (Print Nightmare)"
                    value_type   : POLICY_DWORD
                    value_data   : 1
                    reg_key      : "HKLM\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
                    reg_item     : "NoWarningNoElevationOnInstall"
                    reg_option   : CAN_BE_NULL
                </custom_item>
            </condition>

            <then>
                <report type:"FAILED">
                    description: "CVE-2021-34527 - PointAndPrint Registry setting for NoWarningNoElevationOnInstall is not disabled. (Print Nightmare)"
                    solution     : "Workarounds
                        Determine if the Print Spooler service is running.

                        Run the following in Windows PowerShell:
                        Get-Service -Name Spooler
                        If the Print Spooler is running or if the service is not set to disabled, select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:

                        Option 1 - Disable the Print Spooler service
                        If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:
                        Stop-Service -Name Spooler -Force
                        Set-Service -Name Spooler -StartupType Disabled
                        
                        Impact of workaround Disabling the Print Spooler service disables the ability to print both locally and remotely.
                        
                        Option 2 - Disable inbound remote printing through Group Policy
                        You can also configure the settings via Group Policy as follows:
                        
                        Computer Configuration / Administrative Templates / Printers
                        Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.
                        You must restart the Print Spooler service for the group policy to take effect.
                        
                        Impact of workaround
                        This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible."
                        
                    info         : "A remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.
                    
                        UPDATE July 7, 2021: The security update for Windows Server 2012, Windows Server 2016 and Windows 10, Version 1607 have been released. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability.
                        In order to secure your system, you must confirm that the following registry settings are set to 0 (zero) or are not defined (Note: These registry keys do not exist by default, and therefore are already at the secure setting.):
                        
                        HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
                        NoWarningNoElevationOnInstall = 0 (DWORD) or not defined (default setting)
                        UpdatePromptSettings = 0 (DWORD) or not defined (default setting)
                        Having NoWarningNoElevationOnInstall set to 1 makes your system vulnerable by design.
                        
                        UPDATE July 6, 2021: Microsoft has completed the investigation and has released security updates to address this vulnerability. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability. See also KB5005010: Restricting installation of new printer drivers after applying the July 6, 2021 updates.
                        Note that the security updates released on and after July 6, 2021 contain protections for CVE-2021-1675 and the additional remote code execution exploit in the Windows Print Spooler service known as 'PrintNightmare', documented in CVE-2021-34527."                    
                </report>
            </then>
            <else>
                <report type: "PASSED">
                    description: "CVE-2021-34527 - Point and Print Registry setting NoWarningNoElevationOnInstall is correctly set. (Print Nightmare)"
                </report>
            </else>
        </if>



        <if>
            <condition type: "AND">
                <custom_item>
                    type         : REGISTRY_SETTING
                    description  : "CVE-2021-34527 - Point and Print registry check for PointAndPrint Registry setting for UpdatePromptSettings (Print Nightmare)"
                    value_type   : POLICY_DWORD
                    value_data   : 1
                    reg_key      : "HKLM\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
                    reg_item     : "UpdatePromptSettings"
                    reg_option   : CAN_BE_NULL
                </custom_item>
            </condition>

            <then>
                <report type:"FAILED">
                    description: "CVE-2021-34527 - Point and Print Registry setting for UpdatePromptSettings is not disabled. (Print Nightmare)"
                    solution     : "Workarounds
                        Determine if the Print Spooler service is running.

                        Run the following in Windows PowerShell:
                        Get-Service -Name Spooler
                        If the Print Spooler is running or if the service is not set to disabled, select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:

                        Option 1 - Disable the Print Spooler service
                        If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:
                        Stop-Service -Name Spooler -Force
                        Set-Service -Name Spooler -StartupType Disabled
                        
                        Impact of workaround Disabling the Print Spooler service disables the ability to print both locally and remotely.
                        
                        Option 2 - Disable inbound remote printing through Group Policy
                        You can also configure the settings via Group Policy as follows:
                        
                        Computer Configuration / Administrative Templates / Printers
                        Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.
                        You must restart the Print Spooler service for the group policy to take effect.
                        
                        Impact of workaround
                        This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible."
                        
                    info         : "A remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.
                    
                        UPDATE July 7, 2021: The security update for Windows Server 2012, Windows Server 2016 and Windows 10, Version 1607 have been released. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability.
                        In order to secure your system, you must confirm that the following registry settings are set to 0 (zero) or are not defined (Note: These registry keys do not exist by default, and therefore are already at the secure setting.):
                        
                        HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
                        NoWarningNoElevationOnInstall = 0 (DWORD) or not defined (default setting)
                        UpdatePromptSettings = 0 (DWORD) or not defined (default setting)
                        Having NoWarningNoElevationOnInstall set to 1 makes your system vulnerable by design.
                        
                        UPDATE July 6, 2021: Microsoft has completed the investigation and has released security updates to address this vulnerability. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability. See also KB5005010: Restricting installation of new printer drivers after applying the July 6, 2021 updates.
                        Note that the security updates released on and after July 6, 2021 contain protections for CVE-2021-1675 and the additional remote code execution exploit in the Windows Print Spooler service known as 'PrintNightmare', documented in CVE-2021-34527."                    
                </report>
            </then>
            <else>
                <report type: "PASSED">
                    description: "CVE-2021-34527 - PointAndPrint Registry setting for UpdatePromptSettings is correctly set. (Print Nightmare)"
                </report>
            </else>
        </if>

        <if>
            <condition type:"AND">
                <custom_item>
                    type         : REGISTRY_SETTING
                    description  : "CVE-2021-34527 - Disable inbound remote printing (Print Nightmare) 1"
                    value_type   : POLICY_DWORD
                    value_data   : 2
                    reg_key      : "HKLM\Software\Policies\Microsoft\Windows NT\Printers"
                    reg_item     : "RegisterSpoolerRemoteRpcEndPoint"
                    reg_option   : CAN_NOT_BE_NULL
                </custom_item>
            </condition>

            <then>
                <report type:"PASSED">
                    info: "CVE-2021-34527 - Remote printing is disabled. (Print Nightmare)"
                    description  : "CVE-2021-34527 - Inbound remote printing is Disabled. (Print Nightmare)"
                </report>
            </then>

            <else>
                <report type: "FAILED">
                    description: "CVE-2021-34527 - Disable inbound remote printing. (Print Nightmare)"
                    info        : "A remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.
                                UPDATE July 7, 2021: The security update for Windows Server 2012, Windows Server 2016 and Windows 10, Version 1607 have been released. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability.

                                In order to secure your system, you must confirm that the following registry settings are set to 0 (zero) or are not defined (Note: These registry keys do not exist by default, and therefore are already at the secure setting.):
                                HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
                                NoWarningNoElevationOnInstall = 0 (DWORD) or not defined (default setting)
                                UpdatePromptSettings = 0 (DWORD) or not defined (default setting)
                                Having NoWarningNoElevationOnInstall set to 1 makes your system vulnerable by design.
                                
                                UPDATE July 6, 2021: Microsoft has completed the investigation and has released security updates to address this vulnerability. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability. See also KB5005010: Restricting installation of new printer drivers after applying the July 6, 2021 updates.
                                Note that the security updates released on and after July 6, 2021 contain protections for CVE-2021-1675 and the additional remote code execution exploit in the Windows Print Spooler service known as 'PrintNightmare', documented in CVE-2021-34527."
                    solution    : "Workarounds
                                
                                Determine if the Print Spooler service is running
                                Run the following in Windows PowerShell:
                                Get-Service -Name Spooler
                                
                                If the Print Spooler is running or if the service is not set to disabled, select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:
                                Option 1 - Disable the Print Spooler service
                                If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:
                                Stop-Service -Name Spooler -Force
                                Set-Service -Name Spooler -StartupType Disabled
                                
                                Impact of workaround
                                Disabling the Print Spooler service disables the ability to print both locally and remotely.
                                
                                Option 2 - Disable inbound remote printing through Group Policy
                                You can also configure the settings via Group Policy as follows:
                                Computer Configuration / Administrative Templates / Printers
                                Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.
                                You must restart the Print Spooler service for the group policy to take effect.
                                
                                Impact of workaround
                                This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible."
                </report>
            </else>
        </if>

        <if>
            <condition type:"AND">
                <custom_item>
                    type         : SERVICE_POLICY
                    description  : "Print Spooler service is Disabled"
                    value_type   : SERVICE_SET
                    value_data   : "Disabled"
                    service_name : "Spooler"
                    svc_option   : CAN_BE_NULL
                </custom_item>
            </condition>

            <then>
                <report type: "PASSED">
                    description  : "Print Spooler service is Disabled"
                </report>
                <custom_item>
                    type         : SERVICE_POLICY
                    description  : "Print Spooler service is Disabled"
                    value_type   : SERVICE_SET
                    value_data   : "Disabled"
                    service_name : "Spooler"
                    svc_option   : CAN_BE_NULL
                </custom_item>
            </then> 

            <else>
                <report type: "FAILED">
                    description: "Print Spooler service is Enabled. (Print Nightmare)."
                    info         : "A remote code execution vulnerability exists when the Windows Print Spooler service improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.
                    
                        UPDATE July 7, 2021: The security update for Windows Server 2012, Windows Server 2016 and Windows 10, Version 1607 have been released. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability.
                        In order to secure your system, you must confirm that the following registry settings are set to 0 (zero) or are not defined (Note: These registry keys do not exist by default, and therefore are already at the secure setting.):
                        
                        HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
                        NoWarningNoElevationOnInstall = 0 (DWORD) or not defined (default setting)
                        UpdatePromptSettings = 0 (DWORD) or not defined (default setting)
                        Having NoWarningNoElevationOnInstall set to 1 makes your system vulnerable by design.
                        
                        UPDATE July 6, 2021: Microsoft has completed the investigation and has released security updates to address this vulnerability. Please see the Security Updates table for the applicable update for your system. We recommend that you install these updates immediately. If you are unable to install these updates, see the FAQ and Workaround sections in this CVE for information on how to help protect your system from this vulnerability. See also KB5005010: Restricting installation of new printer drivers after applying the July 6, 2021 updates.
                        Note that the security updates released on and after July 6, 2021 contain protections for CVE-2021-1675 and the additional remote code execution exploit in the Windows Print Spooler service known as 'PrintNightmare', documented in CVE-2021-34527."
                    
                    solution     : "Workarounds Determine if the Print Spooler service is running
                        Run the following in Windows PowerShell:
                        Get-Service -Name Spooler
                        If the Print Spooler is running or if the service is not set to disabled, select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:
                        
                        Option 1 - Disable the Print Spooler service
                        If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:
                        Stop-Service -Name Spooler -Force
                        Set-Service -Name Spooler -StartupType Disabled
                        Impact of workaround Disabling the Print Spooler service disables the ability to print both locally and remotely.
                        
                        Option 2 - Disable inbound remote printing through Group Policy
                        You can also configure the settings via Group Policy as follows:
                        Computer Configuration / Administrative Templates / Printers
                        Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.
                        You must restart the Print Spooler service for the group policy to take effect.
                        
                        Impact of workaround
                        This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible."
                </report>
            </else>
        </if>                     
    </group_policy>
</check_type>